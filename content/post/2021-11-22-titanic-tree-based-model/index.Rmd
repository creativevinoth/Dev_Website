---
title: Titanic Tree Based Model
author: ''
date: '2021-11-22'
slug: titanic-tree-based-model
categories: []
tags: []
---
```{r message = FALSE, warning = FALSE, echo = FALSE}

library(ggplot2)
library(dplyr)
library(data.table)
library(tidyr)
library(GGally)
library(gapminder)
library(tidyverse)
library(pastecs)
library(ggpubr)
library(fastDummies)
library(QuantPsyc)
library(MASS)
library(caret)
library(leaps)
library(summarytools)
library(epiDisplay)
library(tidymodels)
library(Rmisc)
library(Amelia)
library(ranger)
```
```{r message = FALSE, warning = FALSE, echo = FALSE, include = FALSE}
titanic3 <- read.csv("titanic3.csv", na.strings = "")
```


# Summary
```{r}
summary(titanic3)
```
We can see above the NA values are in age, fare and body but character variable NA values are not given above. Hence, we use misssmap to visualize the NA values.

# Cleaning and preparing the dataset

```{r}
missmap(titanic3, col = c("black", "grey"))
```
We can see many NA values for body, cabin, boat, home.dest and age and we can intuitively decide that body, Cabin, boat, home.dest will not impact the survival. Age also has some NA values but it is likely that it will impact the survival and we will remove the NA values. Though there is no NA for name and ticket number, we can intutively remove those as it will not impact survival

# Removing cabin, body, boat and home.dest
```{r}
titanic3 <- subset (titanic3, select = - cabin)
titanic3 <- subset (titanic3, select = - body)
titanic3 <- subset (titanic3, select = - boat)
titanic3 <- subset (titanic3, select = - home.dest)
titanic3 <- subset (titanic3, select = - name)
titanic3 <- subset (titanic3, select = - ticket)

```


# Dropping the missing values
```{r}
titanic3 = na.omit(titanic3)
```

# summary after removing NA
```{r}
summary(titanic3)
```
# Descriptive Statistics
```{r}
descr(titanic3)
```
# Structure of the data
```{r}
str(titanic3)
```
pclass is the ticket class and it is ordinal categorical value but it is taken as integer. Survived is a nominal categorical value but taken as integer. Hence, I change both as a categorical values

# Changing survived and pclass as categorical value
```{r}
titanic3$survived = factor(titanic3$survived)
titanic3$pclass = factor(titanic3$pclass, order=TRUE, levels = c(3, 2, 1))
```

# Revised structure
```{r}
str(titanic3)
```

# Univariate analysis on numerical data

# Univariate analysis on age
```{r}
descr(titanic3$age)
```
# Boxplot of age and its outliers

```{r}
age_outliers<-boxplot.stats(titanic3$age)$out
boxplot(titanic3$age, main = "Box plot of age", boxwex = 0.6)
mtext(paste("Outliers: ", paste(age_outliers, collapse =", ")), cex = 0.6)
age_outliers
```
# Removal of outliers of age
```{r}
titanic3 <- subset (titanic3, age < 67)
```

# Univariate analysis on sibsp
```{r}
descr(titanic3$sibsp)
```

# Boxplot of sibsp and its outliers

```{r}
sibsp_outliers<-boxplot.stats(titanic3$sibsp)$out
boxplot(titanic3$sibsp, main = "Box plot of sibsp", boxwex = 0.6)
mtext(paste("Outliers: ", paste(sibsp_outliers, collapse =", ")), cex = 0.6)
sibsp_outliers
```
# Removal of outliers of sibsp
```{r}
titanic3 <- subset (titanic3, sibsp < 3)
```
Removed siblings/ spouses greater than 3

# Univariate analysis on parch
```{r}
descr(titanic3$parch)
```

# Boxplot of parch and its outliers

```{r}
parch_outliers<-boxplot.stats(titanic3$parch)$out
boxplot(titanic3$parch, main = "Box plot of parch", boxwex = 0.6)
mtext(paste("Outliers: ", paste(parch_outliers, collapse =", ")), cex = 0.6)
parch_outliers
```
Though majority of the data are shown as outliers for parents and childern aboard the Titanic, i feel that they might influence the survival, Hence, I did not remove the outliers or the data

# Univariate analysis on fare
```{r}
descr(titanic3$fare)
```
# Boxplot of fare and its outliers

```{r}
fare_outliers<-boxplot.stats(titanic3$fare)$out
boxplot(titanic3$fare, main = "Box plot of fare", boxwex = 0.6)
mtext(paste("Outliers: ", paste(fare_outliers, collapse =", ")), cex = 0.6)
fare_outliers
```
Here, fare also has more outliers but I don't delete it and keep the file as it is and process further.

# UNivariate analysis on categorical value

# Frequency distribution of pclass
```{r}
tab1(titanic3$pclass, sort.group = "increasing", cum.percent = TRUE, main = "Frequency distribution of pclass", xlab ="pclass")
```

# Frequency distribution of survived
```{r}
tab1(titanic3$survived, sort.group = "increasing", cum.percent = TRUE, main = "Frequency distribution of survived", xlab ="survived")
```

# Frequency distribution of sex
```{r}
tab1(titanic3$sex, sort.group = "increasing", cum.percent = TRUE, main = "Frequency distribution of sex", xlab ="sex")
```

# Frequency distribution of embarked
Writing the embarked data in full words
```{r}
titanic3$embarked[titanic3$embarked == "S" ] <-"Southampton"
titanic3$embarked[titanic3$embarked == "C" ] <-"Cherbourg"
titanic3$embarked[titanic3$embarked == "Q" ] <-"Queenstown"

```


```{r}
tab1(titanic3$embarked, sort.group = "increasing", cum.percent = TRUE, main = "Frequency distribution of embarked", xlab ="embarked")
```

# Bivariate analysis to see the relationship between dependant and independant variable

# Relationship between survived and pclass
```{r}
pclass_survived = glm(survived~ pclass, data = titanic3, family = "binomial")
summary(pclass_survived)
```

```{r}
ggplot(titanic3, aes(x = survived, fill = pclass)) + geom_bar(position = position_dodge())+geom_text(stat = 'count', aes(label = stat(count)), position = position_dodge(width =1), vjust = -0.4)
```

# Relationship between survived and sex
```{r}
sex_survived = glm(survived~ sex, data = titanic3, family = "binomial")
summary(sex_survived)
```

```{r}
ggplot(titanic3, aes(x = survived, fill = sex)) + geom_bar(position = position_dodge())+geom_text(stat = 'count', aes(label = stat(count)), position = position_dodge(width =1), vjust = -0.4)
```

# Relationship between survived and embarked
```{r}
embarked_survived = glm(survived~ embarked, data = titanic3, family = "binomial")
summary(embarked_survived)
```
```{r}
ggplot(titanic3, aes(x = survived, fill = embarked)) + geom_bar(position = position_dodge())+geom_text(stat = 'count', aes(label = stat(count)), position = position_dodge(width =1), vjust = -0.4)
```

# Relationship between survived and age
```{r}
age_survived = glm(survived~ age, data = titanic3, family = "binomial")
summary(age_survived)
```

```{r}
titanic3$discretized.age = cut(titanic3$age, c(0, 10, 20, 30, 40, 50, 60, 70))
ggplot(titanic3, aes(x = discretized.age, fill = survived)) + geom_bar(position = position_dodge())+geom_text(stat = 'count', aes(label = stat(count)), position = position_dodge(width =1), vjust = -0.4)
```

# Relationship between survived and sibsp
```{r}
sibsp_survived = glm(survived~ sibsp, data = titanic3, family = "binomial")
summary(sibsp_survived)
```
```{r}

ggplot(titanic3, aes(x = sibsp, fill = survived)) + geom_bar(position = position_dodge())+geom_text(stat = 'count', aes(label = stat(count)), position = position_dodge(width =1), vjust = -0.4)
```

# Relationship between survived and parch
```{r}
parch_survived = glm(survived~ parch, data = titanic3, family = "binomial")
summary(parch_survived)
```
```{r}
ggplot(titanic3, aes(x = parch, fill = survived)) + geom_bar(position = position_dodge())+geom_text(stat = 'count', aes(label = stat(count)), position = position_dodge(width =1), vjust = -0.4)
```

# Relationship between survived and fare
```{r}
fare_survived = glm(survived~ fare, data = titanic3, family = "binomial")
summary(fare_survived)
```

```{r}
titanic3$discretized.fare = cut(titanic3$fare, c(0, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550))
ggplot(titanic3, aes(x = discretized.fare, fill = survived)) + geom_bar(position = position_dodge())+geom_text(stat = 'count', aes(label = stat(count)), position = position_dodge(width =1), vjust = -0.4)
```

# Data resampling
```{r}
titanic_split <- initial_split (titanic3, prop = 0.80, strata = survived)
titanic_training <- titanic_split %>%
  training()
titanic_test <- titanic_split %>%
  testing()
```


# Checking number of rows in training and test data

```{r}
nrow(titanic_training)
nrow(titanic_test)
```
# Checking multicollinearity between numerical values in a training titanic data set
```{r}
titanic_training %>%
  select_if(is.numeric) %>%
  cor()
```
There is no multicolinearity between the independant variables

# Model specification using decision tree
```{r}
titanic_dt_model<- decision_tree() %>%
  set_engine('rpart') %>%
  set_mode('classification')
```

# Future engineering
This is the step to pre-processing of data
```{r}
titanic_recipe_dt <- recipe(survived ~ sex+ pclass + age + sibsp + parch + fare + embarked, data = titanic_training) %>%
  step_corr(all_numeric(), threshold =0.8) %>%
  step_normalize(all_numeric()) %>%
  step_dummy(all_nominal(), -all_outcomes())
titanic_recipe_dt
```

# Recipe training
```{r}
titanic_recipe_prep_dt<- titanic_recipe_dt %>%
  prep(training = titanic_training)
titanic_recipe_prep_dt
```
# Preprocess training data
```{r}
titanic_training_prep_dt <- titanic_recipe_prep_dt %>%
  bake (new_data = NULL)
titanic_training_prep_dt
```

# Preprocess test data
```{r}
titanic_test_prep_dt <- titanic_recipe_prep_dt %>%
  bake (new_data = titanic_test)
titanic_test_prep_dt
```

# Model fitting
```{r}
titanic_fit_dt <- titanic_dt_model %>%
  fit(survived ~ ., data = titanic_training_prep_dt)
titanic_fit_dt
```
# Predicting outcome variables

```{r}
titanic_class_preds <- predict(titanic_fit_dt, new_data = titanic_test_prep_dt, type = "class")
titanic_class_preds
```
# Estimated probabilities
```{r}
titanic_prob_preds <- predict(titanic_fit_dt, new_data = titanic_test_prep_dt, type = "prob")
titanic_prob_preds
```
# Combining results

```{r}
titanic_results <- titanic_test_prep_dt %>%
  bind_cols(titanic_class_preds, titanic_prob_preds)
titanic_results
```

# Assessing model fit using confusion matrix
```{r}
titanic_results %>%
  conf_mat(truth = survived, estimate = .pred_class) %>%
autoplot(type = 'heatmap')
```


# Combining models and recipe
```{r}
titanic_wkfl_dt<- workflow() %>%
  add_model(titanic_dt_model) %>%
  add_recipe(titanic_recipe_dt)
titanic_wkfl_dt
```

# Model fitting with workflow
```{r}
titanic_wkfl_fit_dt <- titanic_wkfl_dt %>%
  last_fit(split = titanic_split)
titanic_wkfl_fit_dt %>%
  collect_metrics()
```

# Collecting predictions
```{r}
titanic_wkfl_preds_dt <- titanic_wkfl_fit_dt %>%
  collect_predictions()
titanic_wkfl_preds_dt
```

# Confusion matrix
```{r}
conf_mat(titanic_wkfl_preds_dt, truth = survived, estimate = .pred_class) %>%
  autoplot(type = 'heatmap')
```
# Correct predictions
True negative is 108 people, who did not survive. True positive is 56 people survived. 

# Classification error
False positive is 7 people, who are predicted as survived but actually dead. False negative is 27 people, who are predicted as dead but actually survived.

More number of people died in Titanic

# Exploring custom metrics
```{r}
titanic_metrics_dt <- metric_set(roc_auc, sens, spec, accuracy)
titanic_wkfl_preds_dt %>%
titanic_metrics_dt(truth = survived, estimate = .pred_class, .pred_1)
```

# Creating k-fold cross validation
```{r}
set.seed(212)
titanic_folds_dt <- vfold_cv(titanic_training, v = 10, strata = survived)
titanic_folds_dt
```

# Model training with cross validation
```{r}
titanic_rs_fit_dt <-titanic_wkfl_dt %>%
  fit_resamples(resamples = titanic_folds_dt, metrics = titanic_metrics_dt)
titanic_rs_fit_dt %>%
  collect_metrics()
```

# Detailed cross_validation results
```{r}
titanic_rs_metrics_dt <-titanic_rs_fit_dt %>%
  collect_metrics(summarize = FALSE)
titanic_rs_metrics_dt 
```

# Summarizing cross validation results
```{r}
titanic_rs_metrics_dt %>%
  group_by(.metric) %>%
  summarize(min= min(.estimate),
            median = median(.estimate),
            max = max(.estimate),
            sd = sd(.estimate))
```

# Hyper parameter tuning
```{r}
titanic_dt_tune_model <- decision_tree(cost_complexity = tune(), tree_depth = tune(), min_n = tune()) %>%
  set_engine('rpart') %>%
  set_mode('classification')
titanic_dt_tune_model
```

# Creating tuning workflow
```{r}
titanic_tune_wkfl <- titanic_wkfl_dt %>%
  update_model(titanic_dt_tune_model)
titanic_tune_wkfl
```

# Identifying hyperparameters
```{r}
parameters(titanic_dt_tune_model)
```

# Generating random grid
```{r}
set.seed(224)
titanic_dt_grid <- grid_random(parameters(titanic_dt_tune_model), size = 5)
titanic_dt_grid
```

# Hyperparameter tuning with cross validation
```{r}
titanic_dt_tuning <- titanic_tune_wkfl %>%
  tune_grid(resamples= titanic_folds_dt, grid = titanic_dt_grid, metrics = titanic_metrics_dt)
titanic_dt_tuning
```

# Exploring tuning results
```{r}
titanic_dt_tuning %>%
  collect_metrics()
```

# Detailed tuning results
```{r}
titanic_dt_tuning %>%
  collect_metrics(summarize = FALSE)
```

# Exploring tuning results
```{r}
titanic_dt_tuning %>%
  collect_metrics(summarize = FALSE) %>%
  filter(.metric == 'roc_auc') %>%
  group_by (id) %>%
  summarize( min_roc_auc = min(.estimate),
             median_roc_auc = median(.estimate),
             max_roc_auc = max(.estimate))
```

# Viewing the best performing model
```{r}
titanic_dt_tuning %>%
  show_best(metric = 'roc_auc', n =5)
```
Model 1 is the best model
# Selecting the best model
```{r}
titanic_best_dt_model <- titanic_dt_tuning %>%
  select_best(metric = 'roc_auc')
titanic_best_dt_model 
```
The model 1 are best performing model and hyper parameter values

# Finalizing the workflow
```{r}
final_titanic_wkfl_dt <- titanic_tune_wkfl %>%
  finalize_workflow(titanic_best_dt_model)
final_titanic_wkfl_dt
```

# Model fitting
```{r}
titanic_final_fit_dt <- final_titanic_wkfl_dt %>%
  last_fit(split = titanic_split)
titanic_final_fit_dt %>%
  collect_metrics()

```
We can see that there is some improvement compared to what we got from without tuning model

`
```{r}
titanic_prediction<- titanic_final_fit_dt %>%
  collect_predictions()
titanic_prediction
```

```{r}
conf_mat(titanic_prediction, truth = survived, estimate = .pred_class) %>%
  autoplot(type = 'heatmap')
```

# Random forest model
# Model specification using random forest
```{r}
titanic_rf_model<- rand_forest(mtry =4,trees = 100, min_n =10) %>%
  set_engine('ranger') %>%
  set_mode('classification')
```
# Training a forest
```{r}
titanic_fit_rf <- titanic_rf_model %>%
  fit (survived ~ sex+ pclass + age + sibsp + parch + fare + embarked, data = titanic_training)
titanic_fit_rf
```


# Predicting outcome variables

```{r}
titanic_class_preds_rf <- predict(titanic_fit_rf, new_data = titanic_test, type = "class")
titanic_class_preds_rf
```
# Estimated probabilities
```{r}
titanic_prob_preds_rf <- predict(titanic_fit_rf, new_data = titanic_test, type = "prob")
titanic_prob_preds_rf
```
# Combining results

```{r}
titanic_results_rf <- titanic_test %>%
  bind_cols(titanic_class_preds_rf, titanic_prob_preds_rf)
titanic_results_rf
```

# Assessing model fit using confusion matrix
```{r}
titanic_results_rf %>%
  conf_mat(truth = survived, estimate = .pred_class) %>%
autoplot(type = 'heatmap')
```


# Combining models and recipe
```{r}
titanic_wkfl_rf<- workflow() %>%
  add_model(titanic_rf_model) %>%
  add_recipe(titanic_recipe_dt)
titanic_wkfl_rf
```

# Model fitting with workflow
```{r}
titanic_wkfl_fit_rf <- titanic_wkfl_rf %>%
  last_fit(split = titanic_split)
titanic_wkfl_fit_rf %>%
  collect_metrics()
```

# Collecting predictions
```{r}
titanic_wkfl_preds_rf <- titanic_wkfl_fit_rf %>%
  collect_predictions()
titanic_wkfl_preds_rf
```

# Confusion matrix
```{r}
conf_mat(titanic_wkfl_preds_rf, truth = survived, estimate = .pred_class) %>%
  autoplot(type = 'heatmap')
```
# Correct predictions
True negative is 100 people, who did not survive. True positive is 61 people survived. 

# Classification error
False positive is 15 people, who are predicted as survived but actually not survived. False negative is 22 people, who are predicted as not survived but actually survived.

More number of people not survived in Titanic

# Exploring custom metrics
```{r}
titanic_metrics_rf <- metric_set(roc_auc, sens, spec, accuracy)
titanic_wkfl_preds_rf %>%
titanic_metrics_rf(truth = survived, estimate = .pred_class, .pred_1)
```

# Creating k-fold cross validation
```{r}
set.seed(222)
titanic_folds_rf <- vfold_cv(titanic_training, v = 10, strata = survived)
titanic_folds_rf
```

# Model training with cross validation
```{r}
titanic_rs_fit_rf <-titanic_wkfl_rf %>%
  fit_resamples(resamples = titanic_folds_rf, metrics = titanic_metrics_rf)
titanic_rs_fit_rf %>%
  collect_metrics()
```

# Detailed cross_validation results
```{r}
titanic_rs_metrics_rf <-titanic_rs_fit_rf %>%
  collect_metrics(summarize = FALSE)
titanic_rs_metrics_rf 
```

# Summarizing cross validation results
```{r}
titanic_rs_metrics_rf %>%
  group_by(.metric) %>%
  summarize(min= min(.estimate),
            median = median(.estimate),
            max = max(.estimate),
            sd = sd(.estimate))
```

# Hyper parameter tuning
```{r}
titanic_rf_tune_model <- rand_forest(trees = tune(), min_n = tune()) %>%
  set_engine('ranger') %>%
  set_mode('classification')
titanic_rf_tune_model
```

# Creating tuning workflow
```{r}
titanic_tune_wkfl_rf <- titanic_wkfl_rf %>%
  update_model(titanic_rf_tune_model)
titanic_tune_wkfl_rf
```

# Identifying hyperparameters
```{r}
parameters(titanic_rf_tune_model)
```


# Hyperparameter tuning with cross validation
```{r}
titanic_rf_tuning <- titanic_tune_wkfl_rf %>%
  tune_grid(resamples= titanic_folds_rf, metrics = titanic_metrics_rf)
titanic_rf_tuning
```

# Exploring tuning results
```{r}
titanic_rf_tuning %>%
  collect_metrics()
```

# Detailed tuning results
```{r}
titanic_rf_tuning %>%
  collect_metrics(summarize = FALSE)
```

# Exploring tuning results
```{r}
titanic_rf_tuning %>%
  collect_metrics(summarize = FALSE) %>%
  filter(.metric == 'roc_auc') %>%
  group_by (id) %>%
  summarize( min_roc_auc = min(.estimate),
             median_roc_auc = median(.estimate),
             max_roc_auc = max(.estimate))
```

# Viewing the best performing model
```{r}
titanic_rf_tuning %>%
  show_best(metric = 'roc_auc', n =5)
```
Model 5 is the best model
# Selecting the best model
```{r}
titanic_best_rf_model <- titanic_rf_tuning %>%
  select_best(metric = 'roc_auc')
titanic_best_rf_model 
```
The model 5 are best performing model and hyper parameter values

# Finalizing the workflow
```{r}
final_titanic_wkfl_rf <- titanic_tune_wkfl_rf %>%
  finalize_workflow(titanic_best_rf_model)
final_titanic_wkfl_rf
```

# Model fitting
```{r}
titanic_final_fit_rf <- final_titanic_wkfl_rf %>%
  last_fit(split = titanic_split)
titanic_final_fit_rf %>%
  collect_metrics()

```
We can see that there is some improvement compared to what we got from without tuning model

`
```{r}
titanic_prediction_rf<- titanic_final_fit_rf %>%
  collect_predictions()
titanic_prediction_rf
```

```{r}
conf_mat(titanic_prediction_rf, truth = survived, estimate = .pred_class) %>%
  autoplot(type = 'heatmap')
```


